# 适用场景

## 转账业务

某上海账户转账到某北京账户，假设两个账户的相关信息分别存在上海和北京的数据库中。因它们的事务互不相干，有可能出现上海账户扣钱了，北京账户却没收到的错误现象，所以需要分布式事务等相关手段来保证转账业务的原子性，要么扣钱加钱都成功，要么都失败，始终保证两账户余额不变。跨行转账同理。

![](https://oscimg.oschina.net/oscnet/up-974a383f46e2f2fb68db33db248fda79706.png)



## 订单业务

如今，多数电商系统早已转型为分布式/微服务架构(如优惠券、积分、库存和订单等)，txle管理的核心就是全局业务和子业务间的协作，非常适合分布式/微服务架构系统。

多数系统都会预留一定的支付时间(10~30m)，我们可以把订单和支付看作为一个长事务进行管理，且完全不会锁定业务数据资源，这正符合Sagas的长事务模型设计理念，即不干预子业务事务，一定时间后还可通过框架的补偿接口对已完成的子业务进行逆向操作，保证了数据的最终一致性。

a) 如下图，当对不同产品分别下单后，因订单之间相互不产生影响，因此发生异常的订单可以被正确补偿。

![](https://oscimg.oschina.net/oscnet/up-bff0e57316c04d1593a9f2684209d09ab4e.png)

b) 相同产品订单，当发生异常时，也可以被正确补偿。

![](https://oscimg.oschina.net/oscnet/up-5b5d5820f78350f8f633bbe822ef1bc32d9.png)

c) 再来看支付，订单A,B,C均下单成功，但订单B在规定时间内未进行支付或支付失败，此时txle框架将通过补偿接口对订单B进行逆向操作，保证数据的最终一致性。

![](https://oscimg.oschina.net/oscnet/up-9d519ff2aba3853018491cc4ae47b63842b.png)



## 订票业务

这里以订购多程票为例，如上海到莫斯科，莫斯科到巴黎。

一般情况，若莫斯科到巴黎订票失败，那么上海到莫斯科的票也能自动取消，否则很有可能涉及退票费用。与转账业务类似，txle比较适合类似业务场景。



## 不适用场景

当业务满足以下五大因素时，txle处理的还不是很完美。

五大因素：并发 + 热点数据 + 异常 + 中间笔业务 + 非计算型赋值

我们回看订单业务中最后一个场景，订单A,B,C提交成功后，A,C支付成功，B支付失败，图片示例中的确是可以被正确补偿。

但若我们将补偿SQL(num = num + 1)调整为非计算型赋值，即num = 9，考虑事务间的穿插场景，不能直接被赋值为9，因为当前num = 7，直接赋值为9是错误的，所以需调整补偿SQL为num = 9 where num = 8，由于当前num = 7，不满足补偿SQL的条件，因此补偿不将被成功执行。

截止目前，此场景是唯一会导致补偿失败的业务场景，对于一般业务系统而言，同时满足以上五大因素，概率可能也不是特别大，故在此业务场景概率不大的情况下，也是可以考虑的。

当然，补偿失败后，系统会收集业务和事务相关的错误信息，上报至差错平台及存储至本地，供及时分析处理。





## 总结

- 适用于数据实时性要求不高的绝大多数并发业务场景
- 适用于热点数据的大多数并发业务场景
- 适用于热点数据的绝大多数非并发业务场景
- 适用于非热点数据的绝大多数并发业务场景
- 适用于热点数据的绝大多数非并发业务场景

|            | 并发业务                                                     | 非并发业务                                                   |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 热点数据   | ![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx-half.png) | ![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png) |
| 非热点数据 | ![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png) | ![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png)![](pic/wjx.png) |