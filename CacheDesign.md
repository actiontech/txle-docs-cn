# txle缓存设计

## 本地缓存

- 缓存特性：不变、或更新频率非常低

- 缓存逻辑：若未获取到缓存仅读取一次数据库即可，后续均从本地获取即可

- 缓存场景
  - 已备份的业务表名：系统启动后初始化该缓存，某节点新产生的业务备份表将更新至读取节点缓存中，若其它节点未获取到缓存，则需要读取一次数据库
  - 业务表主键：同上
  - 全局事务是否存在状态值：对于任意节点而言，若缓存中无当前全局事务信息，则读取一次数据库即可，后续再次访问相同节点直接命中缓存，因当前事务已存在的状态值永远不会被更改，因此每个节点的这个缓存值都会是一致且正确的
  - 全局事务所属实例和类别，同上



## 本地同步缓存

- 缓存特性：使用频率高、更新频率低

- 缓存逻辑：若未获取到缓存，返回默认值；更新缓存前先执行业务操作，之后再将缓存同步至其它所有节点，成功后更新本地缓存，否则回滚业务操作

- 缓存场景
  - 配置中心：如全局事务启用/停用、服务降级/恢复等业务操作，实时性和一致性要求较高，如某节点执行了服务降级操作，那么需先执行服务降级，再同步缓存至其它节点，最后更新本地缓存



## 分布式缓存

- 缓存特性：使用频率高、更新频率高

- 缓存逻辑：每次从数据库缓存读取

- 缓存场景
  - 全局事务状态：正常请求、超时及配置UI等多处均可能对全局事务的状态进行改变，且无确定时机，在集群部署场景下，极容易导致全局事务状态缓存不一致，即使同一次请求内也无法保证，因此需要采取分布式缓存



## 清除缓存

- 仅对全局事务对应的缓存进行清除，其它属于系统级别缓存生命周期跟随系统
- 全局事务结束时，清除对应的所有缓存
- 为防止系统异常宕机导致无法清除全局事务级别的缓存，系统开启后台定时器，每天凌晨对缓存进行清理操作，主要清理超时且对应全局事务已完成的缓存(默认7天)，未超时已完成将交由下一次超时检测处理，已超时但未完成将由人工手动处理以避免意外发生

